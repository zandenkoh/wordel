<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordel</title>
    <style>
        :root {
            --primary-color: #538d4e;
            --secondary-color: #b59f3b;
            --absent-color: #3a3a3c;
            --background-color: #121213;
            --text-color: #ffffff;
            --tile-size: 62px;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Clear Sans', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        :root.light-theme {
            --primary-color: #2e7d32;
            --secondary-color: #f9a825;
            --absent-color: #757575;
            --background-color: #f5f5f5;
            --text-color: #212121;
        }

        body.light-theme {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 600px;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hidden {
            display: none;
        }

        /* Landing Page */
        .landing {
            text-align: center;
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: 2px solid #ffffff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            background: transparent;
            color: #ffffff;
            transition: all 0.2s;
            margin: 10px;
        }

        .btn:hover {
            background: #ffffff;
            color: #121213;
        }

        .diff-btn {
            padding: 12px 24px;
            border: 2px solid #000;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            background: transparent;
            color: #000;
            transition: all 0.2s;
            margin: 10px;
        }

        .diff-btn:hover {
            background: #000;
            color: #e7e7e7;
        }

        /* Auth Container */
        .auth-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.5s ease-out;
            color: #121213;
            width: 100%;
            max-width: 400px;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .auth-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #121213;
            border-radius: 4px;
            font-size: 16px;
            background: transparent;
            color: #121213;
        }

        .auth-toggle {
            color: #121213;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 10px;
            display: inline-block;
        }

        /* Game Container */
        .game-container {
            text-align: center;
            width: 100%;
            animation: bounceIn 0.5s ease-out;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            60% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(1);
            }
        }

        .wordle-grid {
            display: grid;
            gap: 5px;
            margin: 20px auto;
            width: fit-content;
        }

        .wordle-row {
            display: grid;
            grid-template-columns: repeat(5, var(--tile-size));
            gap: 5px;
            width: fit-content;
            margin-left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
        }

        .wordle-cell {
            width: var(--tile-size);
            height: var(--tile-size);
            border: 2px solid #3a3a3c;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
            background-color: transparent;
            transition: transform 0.2s;
        }

        .filled {
            border-color: #565758;
        }

        .reveal {
            animation: flip 0.5s ease forwards;
        }

        .correct {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .present {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .absent {
            background-color: var(--absent-color);
            border-color: var(--absent-color);
        }

        @keyframes flip {
            0% {
                transform: rotateX(0);
            }

            50% {
                transform: rotateX(90deg);
            }

            100% {
                transform: rotateX(0);
            }
        }

        /* Virtual Keyboard */
        .keyboard {
            margin: 20px auto;
            max-width: 500px;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }

        .key {
            background: #818384;
            color: white;
            padding: 15px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            min-width: 30px;
            text-align: center;
            transition: transform 0.2s;
        }

        .key:hover {
            background: #999;
            transform: scale(1.05);
        }

        .key.correct {
            background: var(--primary-color);
        }

        .key.present {
            background: var(--secondary-color);
        }

        .key.absent {
            background: var(--absent-color);
        }

        /* Leaderboard */
        .leaderboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(18, 18, 19, 0.95);
            padding: 20px;
            color: #ffffff;
            animation: slideUp 0.5s ease-out;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .leaderboard-content {
            width: 100%;
            max-width: 800px;
            background: #ffffff;
            color: #121213;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .leaderboard h2 {
            margin: 0 0 20px;
            font-size: 28px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .leaderboard-entry {
            padding: 15px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
        }

        .leaderboard-entry:nth-child(1) {
            background: var(--gold);
            color: #121213;
            font-weight: bold;
        }

        .leaderboard-entry:nth-child(2) {
            background: var(--silver);
            color: #121213;
        }

        .leaderboard-entry:nth-child(3) {
            background: var(--bronze);
            color: #121213;
        }

        .leaderboard-entry.user {
            background: #f0f0f0;
            border: 2px solid #538d4e;
        }

        .stats-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Teacher Dashboard */
        .teacher-dashboard {
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: #121213;
            animation: slideUp 0.5s ease-out;
            width: 100%;
            max-width: 600px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .word-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .hint-btn {
            background: #ff9800;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin: 10px;
        }

        .hint-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Landing Page -->
        <div id="landing" class="landing">
            <h1>Wordel</h1>
            <p>Master your vocabulary with daily challenges</p>
            <button class="btn" onclick="showLogin()">Join Now</button>
        </div>

        <!-- Auth Container -->
        <div id="auth-container" class="auth-container hidden">
            <h2 id="auth-title">Login to Wordel</h2>
            <input type="text" id="name" class="auth-input hidden" placeholder="Enter your name" required>
            <input type="email" id="email" class="auth-input" placeholder="Enter your email">
            <input type="password" id="password" class="auth-input" placeholder="Enter your password">
            <button class="diff-btn" id="auth-btn" onclick="handleAuth()">Login</button>
            <span class="auth-toggle" onclick="toggleAuthMode()">Need an account? Sign up</span>
            <p id="auth-error" style="color: #ff0000; margin-top: 10px;"></p>
        </div>

        <!-- Game Container -->
        <div id="game-container" class="game-container hidden">
            <h1>Wordel</h1>
            <div id="wordle-grid"></div>
            <div id="keyboard" class="keyboard"></div>
            <button id="hint-btn" class="btn" onclick="useHint()">Get Hint</button>
            <p id="game-message" style="margin-top: 20px;"></p>
            <div>
                <button class="btn" onclick="toggleTheme()">Toggle Theme</button>
                <button class="btn" onclick="editName()">Edit Name</button>
                <button class="btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="teacher-dashboard hidden">
            <h2>Teacher Dashboard</h2>
            <div class="word-input-container">
                <input type="text" id="new-word" class="auth-input" maxlength="5" placeholder="New Word (5 letters)">
                <button class="diff-btn" onclick="updateWord()">Update Word</button>
            </div>
            <div class="stats-grid">
                <div>
                    <h3>Statistics</h3>
                    <p>Total Players: <span id="total-players">0</span></p>
                    <p>Avg Guesses: <span id="avg-guesses">0</span></p>
                    <p>Success Rate: <span id="success-rate">0%</span></p>
                    <p>Daily Completions: <span id="daily-completions">0</span></p>
                </div>
                <div>
                    <h3>Word History</h3>
                    <ul id="word-history"></ul>
                </div>
            </div>
            <div>
                <button class="diff-btn" onclick="editName()">Edit Name</button>
                <button class="diff-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard" class="leaderboard hidden">
            <div class="leaderboard-content">
                <h2>🏆 Daily Leaderboard 🏆</h2>
                <div id="leaderboard-entries"></div>
                <div class="stats-section">
                    <h3>Your Stats</h3>
                    <p>Today's Points: <span id="today-points">0</span></p>
                    <p>Total Points: <span id="total-points">0</span></p>
                    <p>Current Streak: <span id="current-streak">0</span></p>
                    <p>Best Streak: <span id="best-streak">0</span></p>
                    <div id="streak-visual" style="display: flex; gap: 5px; margin-top: 10px;"></div>
                </div>
                <div class="button-group">
                    <button class="diff-btn" onclick="logout()">Logout</button>
                    <button class="diff-btn" onclick="shareScore()">Share Score</button>
                    <button class="diff-btn" onclick="viewProfile()">View Profile</button>
                    <button class="diff-btn" onclick="viewWeekly()">Weekly Rankings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC0PNz0rXt4f9XhR73dws86fWIX6zh3G1E",
            authDomain: "worwordlewordle.firebaseapp.com",
            projectId: "worwordlewordle",
            storageBucket: "worwordlewordle.firebasestorage.app",
            messagingSenderId: "64790438038",
            appId: "1:64790438038:web:4a451cf40d61a051b322b7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const firestore = firebase.firestore();

        const sounds = {
            key: new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'),
            win: new Audio('https://www.soundjay.com/misc/sounds/cheering-01.mp3'),
            lose: new Audio('https://www.soundjay.com/misc/sounds/buzzer-01.mp3')
        };

        // Game State
        let currentUser = null;
        let currentWord = '';
        let guesses = [];
        let currentGuess = '';
        const MAX_GUESSES = 6;
        let validWords = new Set();

        // Fetch valid words from API
        async function fetchValidWords() {
            try {
                const sampleWords = ['apple', 'baker', 'crane', 'drape', 'eagle', 'flame', 'grape',
                    'house', 'igloo', 'joker', 'knife', 'lemon', 'mango', 'noble', 'olive', 'peach',
                    'queen', 'rider', 'snack', 'tiger', 'umbra', 'vivid', 'waste', 'xerox', 'yacht',
                    'zebra', 'learn', 'bread', 'cloud', 'dream'
                ];
                validWords = new Set(sampleWords);
            } catch (error) {
                console.error('Error fetching words:', error);
            }
        }

        // Initialize Game
        function initGame() {
            const grid = document.getElementById('wordle-grid');
            grid.innerHTML = '';
            for (let i = 0; i < MAX_GUESSES; i++) {
                const row = document.createElement('div');
                row.className = 'wordle-row';
                for (let j = 0; j < 5; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'wordle-cell';
                    row.appendChild(cell);
                }
                grid.appendChild(row);
            }
            initKeyboard();
        }

        // Virtual Keyboard
        function initKeyboard() {
            const keyboard = document.getElementById('keyboard');
            const layout = [
                'qwertyuiop',
                'asdfghjkl',
                'zxcvbnm'
            ];
            keyboard.innerHTML = '';
            layout.forEach(row => {
                const div = document.createElement('div');
                div.className = 'keyboard-row';
                if (row === 'zxcvbnm') {
                    const enter = document.createElement('div');
                    enter.className = 'key';
                    enter.textContent = 'Enter';
                    enter.onclick = () => submitGuess();
                    div.appendChild(enter);
                }
                row.split('').forEach(letter => {
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.textContent = letter;
                    key.onclick = () => handleKey(letter);
                    div.appendChild(key);
                });
                if (row === 'zxcvbnm') {
                    const backspace = document.createElement('div');
                    backspace.className = 'key';
                    backspace.textContent = '⌫';
                    backspace.onclick = () => handleKey('Backspace');
                    div.appendChild(backspace);
                }
                keyboard.appendChild(div);
            });
        }

        // Authentication
        function showLogin() {
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');
        }

        function toggleAuthMode() {
            const isSignup = document.getElementById('auth-title').textContent.includes('Sign Up');
            document.getElementById('auth-title').textContent = isSignup ? 'Login to Wordel' : 'Sign Up for Wordel';
            document.getElementById('auth-btn').textContent = isSignup ? 'Login' : 'Sign Up';
            document.querySelector('.auth-toggle').textContent = isSignup ? 'Need an account? Sign up' : 'Have an account? Login';
            document.getElementById('name').classList.toggle('hidden', !isSignup);
        }

        function handleAuth() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const isSignup = document.getElementById('auth-title').textContent.includes('Sign Up');
            const authError = document.getElementById('auth-error');

            if (!email || !password || (isSignup && !name)) {
                authError.textContent = 'Please fill in all fields';
                return;
            }

            if (isSignup) {
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        return firestore.collection('users').doc(user.uid).set({
                            role: 'student',
                            name: name,
                            email: email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            streak: 0,
                            bestStreak: 0,
                            totalPoints: 0,
                            lastPlayed: null
                        });
                    })
                    .catch((error) => {
                        authError.textContent = error.message;
                    });
            } else {
                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => {
                        authError.textContent = error.message;
                    });
            }
        }

        function editName() {
            const newName = prompt('Enter your new name:', currentUser.name || '');
            if (newName) {
                firestore.collection('users').doc(currentUser.uid).update({
                    name: newName
                }).then(() => {
                    currentUser.name = newName;
                    alert('Name updated successfully!');
                });
            }
        }

        function logout() {
            auth.signOut();
            location.reload();
        }

        // Auth State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('landing').classList.add('hidden');
                fetchValidWords().then(() => {
                    firestore.collection('users').doc(user.uid).get()
                        .then((doc) => {
                            const data = doc.data();
                            currentUser.name = data.name; // Store name for leaderboard
                            currentUser.role = data.role;
                            if (data.role === 'teacher') {
                                showTeacherDashboard();
                            } else {
                                showGame();
                            }
                        });
                });
            } else {
                document.getElementById('landing').classList.remove('hidden');
                document.getElementById('game-container').classList.add('hidden');
                document.getElementById('teacher-dashboard').classList.add('hidden');
                document.getElementById('leaderboard').classList.add('hidden');
            }
        });

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        }

        // On page load
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-theme');
            }
        });

        let hintsUsed = false;

        function useHint() {
            if (hintsUsed || guesses.length >= MAX_GUESSES) return;
            const unguessed = currentWord.split('').filter((l, i) => !guesses.some(g => g[i] === l));
            if (unguessed.length > 0) {
                const hintLetter = unguessed[Math.floor(Math.random() * unguessed.length)];
                showMessage(`Hint: The word contains "${hintLetter}"`);
                hintsUsed = true;
                document.getElementById('hint-btn').disabled = true;
            }
        }

        function showGame() {
            document.getElementById('game-container').classList.remove('hidden');
            initGame();
            loadCurrentWord();
            hintsUsed = false;
            document.getElementById('hint-btn').disabled = false;
            document.addEventListener('keydown', handleKey);
        }

        function loadCurrentWord() {
            const today = new Date().toISOString().split('T')[0];
            db.ref('words/' + today).once('value', (snapshot) => {
                currentWord = (snapshot.val()?.word || 'LEARN').toUpperCase();
            });
        }

        function handleKey(event) {
            const key = typeof event === 'string' ? event : event.key;
            if (key === 'Enter') {
                submitGuess();
            } else if (key === 'Backspace') {
                currentGuess = currentGuess.slice(0, -1);
                updateCurrentRow();
            } else if (/^[a-zA-Z]$/.test(key) && currentGuess.length < 5) {
                currentGuess += key.toUpperCase();
                updateCurrentRow();
            }
        }

        function updateCurrentRow() {
            const rows = document.getElementsByClassName('wordle-row');
            const currentRow = rows[guesses.length];
            const cells = currentRow.getElementsByClassName('wordle-cell');

            for (let i = 0; i < 5; i++) {
                cells[i].textContent = currentGuess[i] || '';
                cells[i].classList.toggle('filled', !!currentGuess[i]);
            }
        }

        async function isValidWord(word) {
            if (validWords.has(word.toLowerCase())) return true;
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                const data = await response.json();
                if (Array.isArray(data) && data.length > 0) {
                    validWords.add(word.toLowerCase());
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Word validation error:', error);
                return false;
            }
        }

        async function submitGuess() {
            if (currentGuess.length !== 5) {
                showMessage('Not enough letters');
                return;
            }
            const isValid = await isValidWord(currentGuess);
            if (!isValid) {
                showMessage('Not in word list');
                return;
            }

            guesses.push(currentGuess);
            animateReveal();
            updateKeyboard();
            currentGuess = '';
            setTimeout(checkGameEnd, 1500);
        }

        function animateReveal() {
            const rows = document.getElementsByClassName('wordle-row');
            const row = rows[guesses.length - 1];
            const cells = row.getElementsByClassName('wordle-cell');

            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    cells[i].classList.add('reveal');
                    cells[i].style.animationDelay = `${i * 0.1}s`;
                    if (currentWord[i] === guesses[guesses.length - 1][i]) {
                        cells[i].classList.add('correct');
                    } else if (currentWord.includes(guesses[guesses.length - 1][i])) {
                        cells[i].classList.add('present');
                    } else {
                        cells[i].classList.add('absent');
                    }
                }, i * 200);
            }
        }

        function updateKeyboard() {
            const keys = document.getElementsByClassName('key');
            const lastGuess = guesses[guesses.length - 1];
            Array.from(keys).forEach(key => {
                const letter = key.textContent.toUpperCase();
                if (currentWord.includes(letter) && lastGuess.includes(letter)) {
                    if (currentWord.indexOf(letter) === lastGuess.indexOf(letter)) {
                        key.classList.add('correct');
                    } else {
                        key.classList.add('present');
                    }
                } else if (lastGuess.includes(letter)) {
                    key.classList.add('absent');
                }
            });
        }

        function showMessage(message) {
            const msg = document.getElementById('game-message');
            msg.textContent = message;
            msg.style.opacity = '1';
            setTimeout(() => msg.style.opacity = '0', 2000);
        }

        async function showDefinition(word) {
            const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word.toLowerCase()}`);
            const data = await response.json();
            if (data[0]?.meanings[0]?.definitions[0]?.definition) {
                alert(`Definition of ${word}: ${data[0].meanings[0].definitions[0].definition}`);
            }
        }

        function checkGameEnd() {
            const lastGuess = guesses[guesses.length - 1];
            if (lastGuess === currentWord) {
                showMessage('Great Job!');
                sounds.win.play();
                const points = (MAX_GUESSES - guesses.length + 1) * 100;
                recordGameResult(true, points).then(() => {
                    updateStreak(true);
                    setTimeout(() => showDefinition(currentWord), 1500);
                    setTimeout(() => {
                        document.getElementById('leaderboard').style.display = 'flex';
                        showLeaderboard();
                    }, 1000);
                }).catch((error) => {
                    console.error('Error in checkGameEnd (win):', error);
                });
            } else if (guesses.length === MAX_GUESSES) {
                showMessage(`Game Over! Word was: ${currentWord}`);
                sounds.lose.play();
                recordGameResult(false, 0).then(() => {
                    updateStreak(false);
                    setTimeout(() => {
                        document.getElementById('leaderboard').style.display = 'flex';
                        showLeaderboard();
                    }, 1000);
                }).catch((error) => {
                    console.error('Error in checkGameEnd (lose):', error);
                });
            }
        }

        const achievements = {
            'First Win': {
                condition: (stats) => stats.totalPoints >= 100,
                desc: 'Win your first game'
            },
            'Streak Master': {
                condition: (stats) => stats.bestStreak >= 5,
                desc: 'Reach a 5-day streak'
            },
            'Quick Learner': {
                condition: (stats) => stats.totalPoints >= 500 && stats.streak > 0,
                desc: 'Score 500 points with an active streak'
            }
        };

        function checkAchievements() {
            firestore.collection('users').doc(currentUser.uid).get().then(doc => {
                const stats = doc.data();
                Object.entries(achievements).forEach(([name, {
                    condition,
                    desc
                }]) => {
                    if (condition(stats) && !stats.achievements?.includes(name)) {
                        firestore.collection('users').doc(currentUser.uid).update({
                            achievements: firebase.firestore.FieldValue.arrayUnion(name)
                        });
                        alert(`Achievement Unlocked: ${name} - ${desc}`);
                    }
                });
            });
        }

        async function recordGameResult(success, points) {
            const today = new Date().toISOString().split('T')[0];
            try {
                // Record the game result
                await firestore.collection('gameResults').add({
                    userId: currentUser.uid,
                    name: currentUser.name || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    date: today,
                    guesses: guesses.length,
                    success: success,
                    points: points,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update total points if successful
                if (success && points > 0) {
                    await firestore.collection('users').doc(currentUser.uid).update({
                        totalPoints: firebase.firestore.FieldValue.increment(points)
                    });
                    console.log(`Points incremented by ${points} for user ${currentUser.uid}`);
                }
                checkAchievements();
            } catch (error) {
                console.error('Error recording game result:', error);
            }
        }

        function updateStreak(success) {
            const today = new Date().toISOString().split('T')[0];
            firestore.collection('users').doc(currentUser.uid).get().then(doc => {
                const {
                    streak,
                    bestStreak,
                    lastPlayed
                } = doc.data();
                let newStreak = success ? streak + 1 : 0;
                const newBestStreak = Math.max(bestStreak, newStreak);
                if (lastPlayed !== today) {
                    firestore.collection('users').doc(currentUser.uid).update({
                        streak: newStreak,
                        bestStreak: newBestStreak,
                        lastPlayed: today
                    });
                }
            });
        }

        function showLeaderboard() {
            const today = new Date().toISOString().split('T')[0];
            Promise.all([
                firestore.collection('gameResults')
                .where('date', '==', today)
                .orderBy('points', 'desc')
                .orderBy('timestamp', 'asc')
                .get(),
                firestore.collection('users').doc(currentUser.uid).get()
            ]).then(([snapshot, userDoc]) => {
                const leaderboard = document.getElementById('leaderboard-entries');
                leaderboard.innerHTML = '';
                let userPosition = -1;

                // Map to store the highest score per user
                const userScores = new Map();
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (!userScores.has(data.userId) || userScores.get(data.userId).points < data.points) {
                        userScores.set(data.userId, {
                            name: data.name,
                            points: data.points,
                            userId: data.userId
                        });
                    }
                });

                // Convert to array and sort by points
                const rankedUsers = Array.from(userScores.values())
                    .sort((a, b) => b.points - a.points || a.name.localeCompare(b.name))
                    .slice(0, 10); // Top 10

                rankedUsers.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-entry';
                    div.id = `position-${index}`;
                    const trophy = index < 3 ? ['🥇', '🥈', '🥉'][index] : `${index + 1}.`;
                    div.innerHTML = `
                <span>${trophy} ${user.name}</span>
                <span>${user.points} pts</span>
            `;
                    if (user.userId === currentUser.uid) {
                        div.classList.add('user');
                        userPosition = index;
                    }
                    leaderboard.appendChild(div);
                });

                // User Stats
                const userData = userDoc.data();
                document.getElementById('today-points').textContent = snapshot.docs.find(doc => doc.data().userId === currentUser.uid)?.data().points || 0;
                document.getElementById('total-points').textContent = userData.totalPoints || 0;
                document.getElementById('current-streak').textContent = userData.streak || 0;
                document.getElementById('best-streak').textContent = userData.bestStreak || 0;

                const streakVisual = document.getElementById('streak-visual');
                streakVisual.innerHTML = '';
                for (let i = 0; i < userData.streak; i++) {
                    const dot = document.createElement('div');
                    dot.style.width = '10px';
                    dot.style.height = '10px';
                    dot.style.background = 'var(--primary-color)';
                    dot.style.borderRadius = '50%';
                    streakVisual.appendChild(dot);
                }

                if (userPosition >= 0) {
                    const userElement = document.getElementById(`position-${userPosition}`);
                    userElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }).catch((error) => {
                console.error('Error showing leaderboard:', error);
            });
        }

        function closeLeaderboard() {
            document.getElementById('leaderboard').style.display = 'none';
            guesses = [];
            currentGuess = '';
            document.removeEventListener('keydown', handleKey);
            showGame();
        }

        function shareScore() {
            const todayPoints = document.getElementById('today-points').textContent;
            let emojiGrid = guesses.map(guess => {
                return guess.split('').map((letter, i) => {
                    if (currentWord[i] === letter) return '🟩';
                    if (currentWord.includes(letter)) return '🟨';
                    return '⬜';
                }).join('');
            }).join('\n');
            const text = `Wordel ${guesses.length}/${MAX_GUESSES}\n${emojiGrid}\nScored ${todayPoints} points!`;
            navigator.clipboard.writeText(text).then(() => alert('Score copied to clipboard!'));
        }

        function viewProfile() {
            alert(`Name: ${currentUser.name}\nTotal Points: ${document.getElementById('total-points').textContent}\nCurrent Streak: ${document.getElementById('current-streak').textContent}\nBest Streak: ${document.getElementById('best-streak').textContent}`);
        }

        function viewWeekly() {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekAgoStr = weekAgo.toISOString().split('T')[0];
            firestore.collection('gameResults')
                .where('date', '>=', weekAgoStr)
                .orderBy('date', 'desc')
                .orderBy('points', 'desc')
                .limit(10)
                .get()
                .then((snapshot) => {
                    let weekly = 'Weekly Rankings (Last 7 Days):\n';
                    snapshot.docs.forEach((doc, index) => {
                        const data = doc.data();
                        weekly += `${index + 1}. ${data.name} - ${data.points} pts (${data.date})\n`;
                    });
                    alert(weekly);
                });
        }

        // Teacher Dashboard
        function showTeacherDashboard() {
            document.getElementById('teacher-dashboard').classList.remove('hidden');
            loadTeacherStats();
            loadWordHistory();
        }

        async function updateWord() {
            const newWord = document.getElementById('new-word').value.toUpperCase();
            if (newWord.length !== 5) {
                alert('Word must be 5 letters');
                return;
            }
            const isValid = await isValidWord(newWord);
            if (!isValid) {
                alert('Not a valid word');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            db.ref('words/' + today).set({
                word: newWord,
                setBy: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                loadWordHistory();
                document.getElementById('new-word').value = '';
            });
        }

        function loadTeacherStats() {
            const today = new Date().toISOString().split('T')[0];
            firestore.collection('gameResults').get().then((snapshot) => {
                const totalPlayers = new Set(snapshot.docs.map(doc => doc.data().userId)).size;
                const successes = snapshot.docs.filter(doc => doc.data().success).length;
                const totalGuesses = snapshot.docs.reduce((sum, doc) => sum + doc.data().guesses, 0);
                const dailyCompletions = snapshot.docs.filter(doc => doc.data().date === today && doc.data().success).length;

                document.getElementById('total-players').textContent = totalPlayers;
                document.getElementById('success-rate').textContent =
                    ((successes / snapshot.docs.length) * 100 || 0).toFixed(1) + '%';
                document.getElementById('avg-guesses').textContent =
                    (totalGuesses / snapshot.docs.length || 0).toFixed(1);
                document.getElementById('daily-completions').textContent = dailyCompletions;
            });
        }

        function loadWordHistory() {
            db.ref('words').orderByChild('timestamp').limitToLast(10).once('value', (snapshot) => {
                const history = document.getElementById('word-history');
                history.innerHTML = '';
                snapshot.forEach((child) => {
                    const li = document.createElement('li');
                    li.textContent = `${child.key}: ${child.val().word}`;
                    history.appendChild(li);
                });
            });
        }
    </script>
</body>

</html>
